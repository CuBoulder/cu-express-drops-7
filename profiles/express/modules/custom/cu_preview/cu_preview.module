<?php

/**
 * Define site permissions in code.
 *
 * Create a secure_permissions_data module directory and place this function
 * in secure_permissions_data.module.
 *
 * @param $role
 *   The role for which the permissions are being requested.
 *
 * @return
 *   An array defining all the permissions for the site.
 */
  
function cu_preview_secure_permissions($role) {
  $permissions = array(
    'administrator' => array(
      'access navbar',
      'enable module bundles',
    ),
    'content_editor' => array(
      'access navbar',
    ),
    'developer' => array(
      'access navbar',
      'enable module bundles',
    ),
    'site_owner' => array(
      'access navbar',
      'enable module bundles',
    ),
    'edit_my_content' => array(
      'access navbar',
    ),
  );
  if (isset($permissions[$role])) {
    return $permissions[$role];
  }
}



// THIS HOOK WILL EVENTUALLY REPLACE CU_SETTINGS 
/**
 * Implements hook_menu().
 */
function cu_preview_menu() {
  $items['admin/settings'] = array(
    'title' => 'Settings',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'cu_settings_management_page',
    'access arguments' => array('administer cu settings'),
    'weight' => 8,
  );
  
  // GETTING STARTED
  $items['admin/settings/getting-started'] = array(
      'title' => 'Getting Started',
      'description' => 'Menu Options Related to Getting Started',
      'position' => 'left',
      'page callback' => 'system_admin_menu_block_page',
      'access arguments' => array('administer cu settings'),
      'file' => 'system.admin.inc',
      'file path' => drupal_get_path('module', 'system'),
      'weight' => 0,
  );
  $items['admin/settings/getting-started/site'] = array(
    'title' => 'Settings',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('cu_settings_admin_settings_form'),
    'access arguments' => array('administer cu settings'),
    'weight' => 8,
  );
  $items['admin/settings/getting-started/contact'] = array(
    'title' => 'Contact Information',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('cu_settings_contact_info_form'),
    'access arguments' => array('administer cu settings'),
  );
  $items['admin/settings/getting-started/error'] = array(
    'title' => 'Error Pages',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('cu_settings_error_form'),
    'access arguments' => array('administer cu settings'),
  );
  $items['admin/settings/getting-started/redirects'] = array(
    'title' => 'URL Redirects',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'drupal_goto',
    'page arguments' => array('admin/config/search/redirect'),
    'access arguments' => array('administer redirects'),
  );
  
 // PEOPLE BLOCK
  $items['admin/settings/people'] = array(
    'title' => 'People',
    'description' => 'Menu Options Related to Feedback',
    'position' => 'right',
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('administer cu settings'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
    'weight' => 1,
  );
  $items['admin/settings/people/settings'] = array(
	  'title' => 'People Filter Labels',
		'type' => MENU_NORMAL_ITEM,
		'page callback' => 'drupal_get_form',
	  'page arguments' => array('people_content_type_admin_settings_form'),
		'access arguments' => array('administer cu settings'),
	);
  
  // FEEDBACK BLOCK
  $items['admin/settings/feedback'] = array(
    'title' => 'Feedback',
    'description' => 'Menu Options Related to Feedback',
    'position' => 'right',
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('administer cu settings'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
    'weight' => 2,
  );
	$items['admin/settings/feedback/settings'] = array(
		'title' => 'Feedback Form',
		'type' => MENU_NORMAL_ITEM,
		'page callback' => 'drupal_get_form',
		'page arguments' => array('cu_feedback_admin_settings_form'),
		'access arguments' => array('administer cu feedback module'),
	);
  
 
  return $items;
}

/**
 * Implements hook_flush_caches().
 */
function cu_preview_flush_caches() {

  $mlid = db_query("SELECT mlid FROM {menu_links} WHERE link_path = 'admin/settings'")->fetchField();
  // fix people
  $people_mlid =  db_query("SELECT mlid FROM {menu_links} WHERE link_path = 'admin/settings/people'")->fetchField();
  $item = menu_link_load($people_mlid);
  if($item['mlid']) {
    $item['plid'] = $mlid;
    $item['hidden'] = 0;
    menu_link_save($item);
  }
  // fix forms
  $form_mlid =  db_query("SELECT mlid FROM {menu_links} WHERE link_path = 'admin/settings/feedback'")->fetchField();
  $item = menu_link_load($form_mlid);
  if($item['mlid']) {
    $item['plid'] = $mlid;
    $item['hidden'] = 0;
    menu_link_save($item);
  }
}
